MatricesEnterpriseMobileICSTacticsEnterpriseMobileICSTechniquesEnterpriseMobileICSDefensesData SourcesMitigationsEnterpriseMobileICSAssetsCTIGroupsSoftwareCampaignsResourcesGet StartedLearn More about ATT&CKATT&CKconATT&CK Data & ToolsFAQEngage with ATT&CKVersion HistoryLegal & BrandingBenefactorsBlogSearchATT&CKcon 5.0 returns October 22-23, 2024 in McLean, VA.Register heretoday!HomeTechniquesEnterpriseAccess Token ManipulationSID-History InjectionAccess Token Manipulation:SID-History InjectionOther sub-techniques of Access Token Manipulation (5)IDNameT1134.001Token Impersonation/TheftT1134.002Create Process with TokenT1134.003Make and Impersonate TokenT1134.004Parent PID SpoofingT1134.005SID-History InjectionAdversaries may use SID-History Injection to escalate privileges and bypass access controls. The Windows security identifier (SID) is a unique value that identifies a user or group account. SIDs are used by Windows security in both security descriptors and access tokens.[1]An account can hold additional SIDs in the SID-History Active Directory attribute[2], allowing inter-operable account migration between domains (e.g., all values in SID-History are included in access tokens).With Domain Administrator (or equivalent) rights, harvested or well-known SID values[3]may be inserted into SID-History to enable impersonation of arbitrary users/groups such as Enterprise Administrators. This manipulation may result in elevated access to local resources and/or access to otherwise inaccessible domains via lateral movement techniques such asRemote Services,SMB/Windows Admin Shares, orWindows Remote Management.ID:T1134.005Sub-technique of:T1134ⓘTactics:Defense Evasion,Privilege EscalationⓘPlatforms:WindowsⓘPermissions Required:Administrator, SYSTEMContributors:Alain Homewood, Insomnia Security; Vincent Le TouxVersion:1.0Created:18 February 2020Last Modified:09 February 2021Version PermalinkLive VersionProcedure ExamplesIDNameDescriptionS0363EmpireEmpirecan add a SID-History to a user if on a domain controller.[4]S0002MimikatzMimikatz'sMISC::AddSidmodule can append any SID or user/group account to a user's SID-History.Mimikatzalso utilizesSID-History Injectionto expand the scope of other components such as generated Kerberos Golden Tickets and DCSync beyond a single domain.[5][6]MitigationsIDMitigationDescriptionM1015Active Directory ConfigurationClean up SID-History attributes after legitimate account migration is complete.Consider applying SID Filtering to interforest trusts, such as forest trusts and external trusts, to exclude SID-History from requests to access domain resources. SID Filtering ensures that any authentication requests over a trust only contain SIDs of security principals from the trusted domain (i.e preventing the trusted domain from claiming a user has membership in groups outside of the domain).SID Filtering of forest trusts is enabled by default, but may have been disabled in some cases to allow a child domain to transitively access forest trusts. SID Filtering of external trusts is automatically enabled on all created external trusts using Server 2003 or later domain controllers.[7][8]However note that SID Filtering is not automatically applied to legacy trusts or may have been deliberately disabled to allow inter-domain access to resources.SID Filtering can be applied by:[9]Disabling SIDHistory on forest trusts using the netdom tool (netdom trust /domain: /EnableSIDHistory:noon the domain controller)Applying SID Filter Quarantining to external trusts using the netdom tool (netdom trust/domain:/quarantine:yeson the domain controller)Applying SID Filtering to domain trusts within a single forest is not recommended as it is an unsupported configuration and can cause breaking changes.[9][6]If a domain within a forest is untrustworthy then it should not be a member of the forest. In this situation it is necessary to first split the trusted and untrusted domains into separate forests where SID Filtering can be applied to an interforest trustDetectionIDData SourceData ComponentDetectsDS0026Active DirectoryActive Directory Object ModificationMonitor for changes to account management events on Domain Controllers for successful and failed changes to SID-History.[10][11]DS0009ProcessOS API ExecutionMonitor for API calls, such as PowerShell's Get-ADUser cmdlet or Windows API DsAddSidHistory function,  to examine data in user’s SID-History attributes, especially users who have SID-History values from the same domain.DS0002User AccountUser Account MetadataExamine data in user’s SID-History attributesReferencesMicrosoft. (n.d.). Security Identifiers. Retrieved November 30, 2017.Microsoft. (n.d.). Active Directory Schema - SID-History attribute. Retrieved November 30, 2017.Microsoft. (2017, June 23). Well-known security identifiers in Windows operating systems. Retrieved November 30, 2017.Schroeder, W., Warner, J., Nelson, M. (n.d.). Github PowerShellEmpire. Retrieved April 28, 2016.Metcalf, S. (2015, November 13). Unofficial Guide to Mimikatz & Command Reference. Retrieved December 23, 2015.Metcalf, S. (2015, August 7). Kerberos Golden Tickets are Now More Golden. Retrieved December 1, 2017.Microsoft. (2014, November 19). Security Considerations for Trusts. Retrieved November 30, 2017.Microsoft. (n.d.). Configuring SID Filter Quarantining on External Trusts. Retrieved November 30, 2017.Microsoft. (2012, September 11). Command-Line Reference - Netdom Trust. Retrieved November 30, 2017.Metcalf, S. (2015, September 19). Sneaky Active Directory Persistence #14: SID History. Retrieved November 30, 2017.Microsoft. (n.d.). Using DsAddSidHistory. Retrieved November 30, 2017.×load more resultsContact UsTerms of UsePrivacy PolicyWebsite Changelog© 2015 - 2024, The MITRE Corporation. MITRE ATT&CK and ATT&CK are registered trademarks of The MITRE Corporation.