MatricesEnterpriseMobileICSTacticsEnterpriseMobileICSTechniquesEnterpriseMobileICSDefensesData SourcesMitigationsEnterpriseMobileICSAssetsCTIGroupsSoftwareCampaignsResourcesGet StartedLearn More about ATT&CKATT&CKconATT&CK Data & ToolsFAQEngage with ATT&CKVersion HistoryLegal & BrandingBenefactorsBlogSearchATT&CKcon 5.0 returns October 22-23, 2024 in McLean, VA.Register heretoday!HomeTechniquesEnterpriseAccess Token ManipulationCreate Process with TokenAccess Token Manipulation:Create Process with TokenOther sub-techniques of Access Token Manipulation (5)IDNameT1134.001Token Impersonation/TheftT1134.002Create Process with TokenT1134.003Make and Impersonate TokenT1134.004Parent PID SpoofingT1134.005SID-History InjectionAdversaries may create a new process with an existing token to escalate privileges and bypass access controls. Processes can be created with the token and resulting security context of another user using features such asCreateProcessWithTokenWandrunas.[1]Creating processes with a token not associated with the current user may require the credentials of the target user, specific privileges to impersonate that user, or access to the token to be used. For example, the token could be duplicated viaToken Impersonation/Theftor created viaMake and Impersonate Tokenbefore being used to create a process.While this technique is distinct fromToken Impersonation/Theft, the techniques can be used in conjunction where a token is duplicated and then used to create a new process.ID:T1134.002Sub-technique of:T1134ⓘTactics:Defense Evasion,Privilege EscalationⓘPlatforms:WindowsⓘDefense Bypassed:File system access controls, System access controls, Windows User Account ControlContributors:Jonny Johnson; Vadim KhrykovVersion:1.2Created:18 February 2020Last Modified:11 April 2023Version PermalinkLive VersionProcedure ExamplesIDNameDescriptionS0456Aria-bodyAria-bodyhas the ability to execute a process usingrunas.[2]S0344AzorultAzorultcan call WTSQueryUserToken and CreateProcessAsUser to start a new process with local system privileges.[3]S0239BankshotBankshotgrabs a user token using WTSQueryUserToken and then creates a process by impersonating a logged-on user.[4]S0363EmpireEmpirecan useInvoke-RunAsto make tokens.[5]S0356KONNIKONNIhas duplicated the token of a high integrity process to spawn an instance of cmd.exe under an impersonated user.[6][7]G0032Lazarus GroupLazarus Groupkeylogger KiloAlfa obtains user tokens from interactive sessions to execute itself with API callCreateProcessAsUserAunder that user's context.[8][9]S0501PipeMonPipeMoncan attempt to gain administrative privileges using token impersonation.[10]S0378PoshC2PoshC2can use Invoke-RunAs to make tokens.[11]S0496REvilREvilcan launch an instance of itself with administrative rights using runas.[12]G0010TurlaTurlaRPC backdoors can impersonate or steal process tokens before executing commands.[13]S0689WhisperGateTheWhisperGatethird stage can use the AdvancedRun.exe tool to execute commands in the context of the Windows TrustedInstaller group via%TEMP%\AdvancedRun.exe" /EXEFilename "C:\Windows\System32\sc.exe" /WindowState 0 /CommandLine "stop WinDefend" /StartDirectory "" /RunAs 8 /Run.[14]S0412ZxShellZxShellhas a command called RunAs, which creates a new process as another user or process context.[15]MitigationsIDMitigationDescriptionM1026Privileged Account ManagementLimit permissions so that users and user groups cannot create tokens. This setting should be defined for the local system account only. GPO: Computer Configuration > [Policies] > Windows Settings > Security Settings > Local Policies > User Rights Assignment: Create a token object.[16]Also define who can create a process level token to only the local and network service through GPO: Computer Configuration > [Policies] > Windows Settings > Security Settings > Local Policies > User Rights Assignment: Replace a process level token.[17]Administrators should log in as a standard user but run their tools with administrator privileges using the built-in access token manipulation commandrunas.[18]M1018User Account ManagementAn adversary must already have administrator level access on the local system to make full use of this technique; be sure to restrict users and accounts to the least privileges they require.DetectionIDData SourceData ComponentDetectsDS0017CommandCommand ExecutionMonitor executed commands and arguments to detect token manipulation by auditing command-line activity. Specifically, analysts should look for use of the runas command or similar artifacts. Detailed command-line logging is not enabled by default in Windows.[19]DS0009ProcessOS API ExecutionMonitor for API calls associated with detecting token manipulation only through careful analysis of user activity, examination of running processes, and correlation with other endpoint and network behavior. Analysts can also monitor for use of Windows APIs such asCreateProcessWithTokenWand correlate activity with other suspicious behavior to reduce false positives that may be due to normal benign use by users and administrators.ReferencesMicrosoft. (2016, August 31). Runas. Retrieved October 1, 2021.CheckPoint. (2020, May 7). Naikon APT: Cyber Espionage Reloaded. Retrieved May 26, 2020.Yan, T., et al. (2018, November 21). New Wine in Old Bottle: New Azorult Variant Found in FindMyName Campaign using Fallout Exploit Kit. Retrieved November 29, 2018.Sherstobitoff, R. (2018, March 08). Hidden Cobra Targets Turkish Financial Sector With New Bankshot Implant. Retrieved May 18, 2018.Schroeder, W., Warner, J., Nelson, M. (n.d.). Github PowerShellEmpire. Retrieved April 28, 2016.Karmi, D. (2020, January 4). A Look Into Konni 2019 Campaign. Retrieved April 28, 2020.Threat Intelligence Team. (2021, August 23). New variant of Konni malware used in campaign targetting Russia. Retrieved January 5, 2022.Novetta Threat Research Group. (2016, February 24). Operation Blockbuster: Unraveling the Long Thread of the Sony Attack. Retrieved February 25, 2016.Novetta Threat Research Group. (2016, February 24). Operation Blockbuster: Tools Report. Retrieved March 10, 2016.Tartare, M. et al. (2020, May 21). No “Game over” for the Winnti Group. Retrieved August 24, 2020.Nettitude. (2018, July 23). Python Server for PoshC2. Retrieved April 23, 2019.Counter Threat Unit Research Team. (2019, September 24). REvil/Sodinokibi Ransomware. Retrieved August 4, 2020.Faou, M. and Dumont R.. (2019, May 29). A dive into Turla PowerShell usage. Retrieved June 14, 2019.Biasini, N. et al.. (2022, January 21). Ukraine Campaign Delivers Defacement and Wipers, in Continued Escalation. Retrieved March 14, 2022.Allievi, A., et al. (2014, October 28). Threat Spotlight: Group 72, Opening the ZxShell. Retrieved September 24, 2019.Brower, N., Lich, B. (2017, April 19). Create a token object. Retrieved December 19, 2017.Brower, N., Lich, B. (2017, April 19). Replace a process level token. Retrieved December 19, 2017.Microsoft TechNet. (n.d.). Runas. Retrieved April 21, 2017.Mathers, B. (2017, March 7). Command line process auditing. Retrieved April 21, 2017.×load more resultsContact UsTerms of UsePrivacy PolicyWebsite Changelog© 2015 - 2024, The MITRE Corporation. MITRE ATT&CK and ATT&CK are registered trademarks of The MITRE Corporation.